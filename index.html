<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; }
* { caret-color: transparent; }

body {
    margin: 0;
    font-family: 'Kanit', sans-serif;
    background: #0b0f14;
    color: #cbd5e1;
}

.card-grid {
    display: grid;
    gap: 28px;
    padding: 28px;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
}

.device-card {
    background: #141a21;
    border: 1px solid #1f2933;
    border-radius: 16px;
    padding: 28px;
    min-height: 220px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: all 0.25s ease;
}

.device-card:hover {
    border-color: #00d4ff;
    box-shadow: 0 0 20px rgba(0, 212, 255, 0.15);
}

.device-card.offline {
    background: #1a1f26;
    border-color: #2a323c;
    opacity: 0.5;
}

.jig-name {
    font-weight: 600;
    color: #00d4ff;
    margin-bottom: 20px;
    white-space: nowrap;
    letter-spacing: 0.5px;
}

.input-row { margin-bottom: 12px; }

.input-value {
    font-size: 38px;
    font-weight: 700;
    color: #00f0ff;
    letter-spacing: 1px;
}

.total-row {
    font-size: 18px;
    color: #94a3b8;
}

.last-update {
    font-size: 13px;
    color: #64748b;
    margin-top: 16px;
}

::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #0b0f14; }
::-webkit-scrollbar-thumb {
    background: #1f2933;
    border-radius: 8px;
}
</style>
</head>
<body>

<div class="card-grid" id="cardContainer"></div>

<script>
const apiUrl = "https://opensheet.elk.sh/1FhLvkCQ2o6ZdRAkx6vjysY9LwC3nQ3EETil7YlKqYlA/DeviceStatus";

let cardMap = new Map();

/* ---------- Auto Scale ---------- */
function autoScaleText(element, maxSize = 28, minSize = 14) {
    let fontSize = maxSize;
    element.style.fontSize = fontSize + "px";

    while (element.scrollWidth > element.offsetWidth && fontSize > minSize) {
        fontSize--;
        element.style.fontSize = fontSize + "px";
    }
}

const resizeObserver = new ResizeObserver(entries => {
    for (let entry of entries) {
        const nameEl = entry.target.querySelector(".jig-name");
        if (nameEl) autoScaleText(nameEl);
    }
});

/* ---------- Offline Check (Robust) ---------- */
function isOffline(timestamp) {
    if (!timestamp) return true;

    const parsed = new Date(timestamp);
    if (isNaN(parsed.getTime())) return true;

    const diffMinutes = (Date.now() - parsed.getTime()) / 1000 / 60;
    return diffMinutes > 20;
}

/* ---------- Load Data ---------- */
async function loadData() {
    const container = document.getElementById("cardContainer");

    try {
        const response = await fetch(apiUrl, { cache: "no-store" });
        const data = await response.json();

        // Safe sort
        data.sort((a, b) => {
            const countDiff = (Number(b.count1) || 0) - (Number(a.count1) || 0);
            if (countDiff !== 0) return countDiff;

            const timeB = new Date(b.Timestamp).getTime() || 0;
            const timeA = new Date(a.Timestamp).getTime() || 0;
            return timeB - timeA;
        });

        /* ===== CREATE / UPDATE ===== */
        data.forEach(item => {
            const id = item.device_id;
            const input = item.count1 ?? 0;
            const total = item.count2 ?? 0;
            const timestamp = item.Timestamp ?? "";

            let card = cardMap.get(id);

            if (!card) {
                card = document.createElement("div");
                card.className = "device-card";
                card.innerHTML = `
                    <div class="jig-name"></div>
                    <div>
                        <div class="input-row">
                            <span class="input-value"></span>
                        </div>
                        <div class="total-row"></div>
                        <div class="last-update"></div>
                    </div>
                `;
                container.appendChild(card);
                cardMap.set(id, card);
                resizeObserver.observe(card);
            }

            card.querySelector(".jig-name").textContent = id;
            card.querySelector(".input-value").textContent = input;
            card.querySelector(".total-row").textContent = "Total: " + total;
            card.querySelector(".last-update").textContent = "Last update: " + timestamp;

            if (isOffline(timestamp)) {
                card.classList.add("offline");
            } else {
                card.classList.remove("offline");
            }
        });

        /* ===== REMOVE MISSING DEVICES ===== */
        const currentIds = new Set(data.map(d => d.device_id));

        cardMap.forEach((card, id) => {
            if (!currentIds.has(id)) {
                resizeObserver.unobserve(card);
                card.remove();
                cardMap.delete(id);
            }
        });

        /* ===== REORDER DOM ===== */
        data.forEach(item => {
            const card = cardMap.get(item.device_id);
            if (card) container.appendChild(card);
        });

    } catch (error) {
        console.error(error);
    }
}

loadData();
setInterval(loadData, 30000);
</script>

</body>
</html>


