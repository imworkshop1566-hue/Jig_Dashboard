<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; }
* { caret-color: transparent; }

body {
    margin: 0;
    font-family: 'Kanit', sans-serif;
    background: #0b0f14;
    color: #cbd5e1;
}

/* ===== HEADER ===== */
.dashboard-header {
    padding: 16px 28px;
    border-bottom: 1px solid #1f2933;
    background: #10151b;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
}

.header-title {
    font-size: 22px;
    font-weight: 600;
    color: #00d4ff;
}

.header-stats {
    display: flex;
    gap: 20px;
    font-size: 14px;
    color: #94a3b8;
    flex-wrap: wrap;
}

.header-stats span strong {
    color: #e2e8f0;
}

.last-refresh {
    font-size: 12px;
    color: #64748b;
}

/* ===== LOADING ===== */
.loading {
    text-align: center;
    padding: 40px;
    font-size: 18px;
    color: #00d4ff;
}

/* ===== GRID ===== */
.card-grid {
    display: grid;
    gap: 28px;
    padding: 28px;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
}

.device-card {
    background: #141a21;
    border: 1px solid #1f2933;
    border-radius: 16px;
    padding: 24px;
    min-height: 300px;
    display: grid;
    grid-template-rows: auto auto 1fr;
    transition: border-color 0.25s ease, box-shadow 0.25s ease;
}

.device-card:hover {
    border-color: #00d4ff;
    box-shadow: 0 0 20px rgba(0,212,255,0.15);
}

.device-card.offline {
    background: #1a1f26;
    border-color: #2a323c;
    opacity: 0.5;
}

.jig-name {
    font-weight: 600;
    color: #00d4ff;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 6px;
}

.count-section {
    display: flex;
    align-items: flex-start;
    flex-direction: column;
    justify-content: center;
    gap: 2px;
}

.input-value {
    font-size: 42px;
    font-weight: 700;
    color: #00f0ff;
}

.info-section {
    display: flex;
    flex-direction: column;
    flex: 1;
}

.total-row {
    font-size: 14px;
    color: #94a3b8;
}

.pm-row {
    font-size: 14px;
    line-height: 1.6;
    color: #ff5252;
    min-height: 50px;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.last-update {
    margin-top: auto;
    align-self: flex-end;
    font-size: 12px;
    color: #64748b;
}

::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #0b0f14; }
::-webkit-scrollbar-thumb {
    background: #1f2933;
    border-radius: 8px;
}
</style>
</head>
<body>

<div class="dashboard-header">
    <div class="header-title">Dashboard</div>
    <div class="header-stats">
        <span>Total: <strong id="totalCount">0</strong></span>
        <span>Online: <strong id="onlineCount">0</strong></span>
        <span>Offline: <strong id="offlineCount">0</strong></span>
        <span class="last-refresh" id="lastRefresh">Last refresh: -</span>
    </div>
</div>

<div class="loading" id="loadingState">Loading devices...</div>

<div class="card-grid" id="cardContainer"></div>

<script>

const apiUrl = "https://opensheet.elk.sh/1FhLvkCQ2o6ZdRAkx6vjysY9LwC3nQ3EETil7YlKqYlA/DeviceStatus";
const pmTopicUrl = "https://opensheet.elk.sh/1FhLvkCQ2o6ZdRAkx6vjysY9LwC3nQ3EETil7YlKqYlA/PMTopic";

let cardMap = new Map();
let PM_RULES = [];
let firstLoad = true;

/* ---------- AUTO SCALE ---------- */
function autoScaleText(element, maxSize = 26, minSize = 14) {
    let fontSize = maxSize;
    element.style.fontSize = fontSize + "px";
    while (element.scrollWidth > element.offsetWidth && fontSize > minSize) {
        fontSize--;
        element.style.fontSize = fontSize + "px";
    }
}

const resizeObserver = new ResizeObserver(entries => {
    for (let entry of entries) {
        const nameEl = entry.target.querySelector(".jig-name");
        if (nameEl) autoScaleText(nameEl);
    }
});

/* ---------- LOAD PM TOPIC ---------- */
async function loadPMTopics() {
    try {
        const res = await fetch(pmTopicUrl, { cache: "no-store" });
        const data = await res.json();
        PM_RULES = data.map(row => ({
            name: row.Items,
            interval: Number(String(row.Cycles).replace(/,/g, ""))
        }));
    } catch (err) {
        console.error("PM Topic load error:", err);
    }
}

/* ---------- OFFLINE CHECK ---------- */
function isOffline(timestamp) {
    if (!timestamp) return true;
    const parsed = new Date(timestamp);
    if (isNaN(parsed.getTime())) return true;
    const diffMinutes = (Date.now() - parsed.getTime()) / 1000 / 60;
    return diffMinutes > 20;
}

/* ---------- PM ZONE ---------- */
function isPMZone(count1) {
    return (count1 >= 1 && count1 <= 10) ||
           (count1 >= 19501 && count1 <= 20000);
}

/* ---------- PM CALCULATION ---------- */
function getPMList(total) {
    const THRESHOLD = 1000;
    let list = [];
    PM_RULES.forEach(rule => {
        let cycle = Math.floor(total / rule.interval);
        let nextTarget = Math.ceil(total / rule.interval) * rule.interval;
        let remaining = nextTarget - total;
        if (cycle > 0 || remaining <= THRESHOLD) {
            list.push(rule.name);
        }
    });
    return list;
}

/* ---------- LOAD DEVICE DATA ---------- */
async function loadData() {

    const container = document.getElementById("cardContainer");
    const loading = document.getElementById("loadingState");

    try {

        if (firstLoad) loading.style.display = "block";

        const response = await fetch(apiUrl, { cache: "no-store" });
        const data = await response.json();

        if (firstLoad) {
            loading.style.display = "none";
            firstLoad = false;
        }

        let onlineCount = 0;
        let offlineCount = 0;

        data.sort((a, b) => {
            const countDiff = (Number(b.count1) || 0) - (Number(a.count1) || 0);
            if (countDiff !== 0) return countDiff;
            const timeB = new Date(b.Timestamp).getTime() || 0;
            const timeA = new Date(a.Timestamp).getTime() || 0;
            return timeB - timeA;
        });

        data.forEach(item => {

            const id = item.device_id;
            const count1 = Number(item.count1 ?? 0);
            const total = Number(item.count2 ?? 0);
            const timestamp = item.Timestamp ?? "";

            let card = cardMap.get(id);

            if (!card) {
                card = document.createElement("div");
                card.className = "device-card";
                card.innerHTML = `
                    <div class="jig-name"></div>
                    <div class="count-section">
                        <div class="input-value"></div>
                        <div class="total-row"></div>
                    </div>
                    <div class="info-section">
                        <div class="pm-row"></div>
                        <div class="last-update"></div>
                    </div>
                `;
                container.appendChild(card);
                cardMap.set(id, card);
                resizeObserver.observe(card);
            }

            card.querySelector(".jig-name").textContent = id;
            card.querySelector(".input-value").textContent = count1.toLocaleString();
            card.querySelector(".total-row").textContent = "Total: " + total.toLocaleString();
            card.querySelector(".last-update").textContent = "Last update: " + timestamp;

            const pmRow = card.querySelector(".pm-row");

            if (isPMZone(count1) && PM_RULES.length > 0) {
                const list = getPMList(total);
                pmRow.innerHTML = list.length > 0
                    ? "ðŸ”§ à¸•à¹‰à¸­à¸‡à¹€à¸Šà¹‡à¸„:<br>" + list.join("<br>")
                    : "à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸–à¸¶à¸‡à¸£à¸­à¸š PM";
            } else {
                pmRow.textContent = "";
            }

            if (isOffline(timestamp)) {
                card.classList.add("offline");
                offlineCount++;
            } else {
                card.classList.remove("offline");
                onlineCount++;
            }

        });

        document.getElementById("totalCount").textContent = data.length;
        document.getElementById("onlineCount").textContent = onlineCount;
        document.getElementById("offlineCount").textContent = offlineCount;
        document.getElementById("lastRefresh").textContent =
            "Last refresh: " + new Date().toLocaleTimeString();

        /* ===== REORDER DOM WITHOUT FLICKER ===== */
        requestAnimationFrame(() => {
            const fragment = document.createDocumentFragment();
            data.forEach(item => {
                const card = cardMap.get(item.device_id);
                if (card) fragment.appendChild(card);
            });
            container.appendChild(fragment);
        });

    } catch (error) {
        console.error("Device load error:", error);
    }
}

/* ---------- INIT ---------- */
async function init() {
    await loadPMTopics();
    await loadData();
    setInterval(loadData, 30000);
    setInterval(loadPMTopics, 60000);
}

init();

</script>
</body>
</html>

